apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cluster-assessment-alerts
  namespace: openshift-cluster-assessment
  labels:
    app.kubernetes.io/name: cluster-assessment-operator
    app.kubernetes.io/managed-by: cluster-assessment-operator
    prometheus: k8s
    role: alert-rules
spec:
  groups:
    - name: cluster-assessment.rules
      rules:
        - alert: ClusterAssessmentScoreLow
          annotations:
            summary: "Cluster assessment score is critically low ({{ $value }}%)"
            description: "The cluster assessment score for {{ $labels.assessment_name }} has dropped below 60% for more than 5 minutes. Immediate attention is required."
            runbook_url: "https://github.com/DiegoBskt/cluster-assessment-operator#troubleshooting"
          expr: cluster_assessment_score < 60
          for: 5m
          labels:
            severity: critical
            namespace: openshift-cluster-assessment

        - alert: ClusterAssessmentScoreDegraded
          annotations:
            summary: "Cluster assessment score is degraded ({{ $value }}%)"
            description: "The cluster assessment score for {{ $labels.assessment_name }} is below 80% for more than 5 minutes."
          expr: cluster_assessment_score < 80 and cluster_assessment_score >= 60
          for: 5m
          labels:
            severity: warning
            namespace: openshift-cluster-assessment

        - alert: ClusterAssessmentRegressions
          annotations:
            summary: "Assessment detected {{ $value }} regressions"
            description: "The cluster assessment for {{ $labels.assessment_name }} has detected findings that worsened since the last run."
          expr: cluster_assessment_regressions_total > 0
          for: 10m
          labels:
            severity: warning
            namespace: openshift-cluster-assessment

        - alert: ClusterAssessmentHighFailCount
          annotations:
            summary: "{{ $value }} failed assessment checks"
            description: "The cluster assessment for {{ $labels.assessment_name }} has more than 5 failed checks."
          expr: cluster_assessment_findings_total{status="FAIL"} > 5
          for: 5m
          labels:
            severity: warning
            namespace: openshift-cluster-assessment

        - alert: ClusterAssessmentStale
          annotations:
            summary: "Cluster assessment has not run recently"
            description: "The cluster assessment for {{ $labels.assessment_name }} has not run in over 24 hours."
          expr: time() - cluster_assessment_last_run_timestamp > 86400
          for: 30m
          labels:
            severity: warning
            namespace: openshift-cluster-assessment
